<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>dbpmail.net :: TDD with Haskell and the Snap Web Framework</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="navigation">
            <a href="http://dbpmail.net">dbpmail.net</a>
            <a href="#" title="site created with hakyll, http://jaspervdj.be/hakyll/">::</a>
            <a href="../index.html">About</a>
            <a href="../essays.html">Essays</a>
            <a href="../projects.html">Projects</a>
            <a href="http://photo.dbpmail.net">Photos</a>
        </div>
        <h2>TDD with Haskell and the Snap Web Framework</h2>

<p>by <em>Daniel Patterson</em> on <strong>January  6, 2013</strong></p>

<p>Test driven development is nothing new - people have been talking about it in various forms for at least 14 years<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>. Within the web development community, it is used most strongly within dynamic languages, with Ruby probably being the best example, both in quality of libraries and pervasive use. And with good reason - without tests you really have no idea if the changes you’ve made have just broken your whole site.</p>
<p>Adoption within the Haskell community is a little more complicated. In one sense, some pretty amazing testing libraries have been developed, with QuickCheck (and related property based testing libraries) being the best example. The idea of generating either random data and automated minimization is really neat for testing. At the same time, a common response to the question of testing in Haskell is that the type system eliminates the need for it. While it certainly eliminates the need for certain types of tests (tests that you <em>would</em> need to write in Ruby), the bulk of the tests that I write when doing web development in dynamic languages like Ruby are not tests that the type system has anything to say about. In particular, monadic code in the context of a web framework like Snap makes it quite easy to write bugs in ways that are not type observable (for example, in the context of MonadPlus, if you fail out in some computation, there will be no type errors, even if many, or most of the web handlers are now 404ing). And this isn’t a bad thing - it makes it really convenient to write the impure web handling code that you want, without giving up being able to leverage Haskell’s type system to check lots of things.</p>
<p>With this in mind, I haven’t found much (or really anything) among open source libraries. Which isn’t to say people aren’t writing tests of web handlers, just that if they are, they are keeping it quiet. What I have here is the beginnings of a library to make writing those tests easier. It is very much a work in progress, has not been released anywhere yet. I’ve also done some experiments autorunning the tests, or with test discovery, but am not including them here (I think they distract from the central ideas).</p>
<p>So first here is a set of tests from an application I’m working on now (imports skipped, see the full code <a href="https://github.com/dbp/analyze/blob/ed56691c48245531dc646ad9704c2eb0acd3b4d0/src/Test/Top.hs">here</a>):</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> runSnapTests (route routes) app <span class="fu">$</span> <span class="kw">do</span>
  name <span class="st">&quot;/ success&quot;</span> <span class="fu">$</span>
    succeeds (get <span class="st">&quot;/&quot;</span>)
  name <span class="st">&quot;/foo/bar not found&quot;</span> <span class="fu">$</span>
    notfound (get <span class="st">&quot;/foo/bar&quot;</span>)
  name <span class="st">&quot;/auth/new_user success&quot;</span> <span class="fu">$</span>
    succeeds (get <span class="st">&quot;/auth/new_user&quot;</span>)

  name <span class="st">&quot;/auth/new_user creates a new account&quot;</span> <span class="fu">$</span>
    cleanup clearAccounts <span class="fu">$</span>
    changes (<span class="fu">+</span><span class="dv">1</span>) countAccounts (post <span class="st">&quot;/auth/new_user&quot;</span> <span class="fu">$</span> params
                                [ (<span class="st">&quot;new_user.name&quot;</span>, <span class="st">&quot;Jane&quot;</span>)
                                , (<span class="st">&quot;new_user.email&quot;</span>, <span class="st">&quot;jdoe@c.com&quot;</span>)
                                , (<span class="st">&quot;new_user.password&quot;</span>, <span class="st">&quot;foobar&quot;</span>)])

  name <span class="st">&quot;/site/new redirect without login&quot;</span> <span class="fu">$</span>
    redirects (get <span class="st">&quot;/site/new&quot;</span>)
  cleanup clearAccounts <span class="fu">$</span> withUser <span class="fu">$</span> <span class="kw">do</span>
    name <span class="st">&quot;/new success with login&quot;</span> <span class="fu">$</span>
      succeeds (get <span class="st">&quot;/site/new&quot;</span>)
    name <span class="st">&quot;/site/new creates a new site&quot;</span> <span class="fu">$</span>
      changes (<span class="fu">+</span><span class="dv">1</span>) countSites
       (post <span class="st">&quot;/site/new&quot;</span> <span class="fu">$</span> params [
         (<span class="st">&quot;new_site.name&quot;</span>, <span class="st">&quot;Acme&quot;</span>)
         , (<span class="st">&quot;new_site.url&quot;</span>, <span class="st">&quot;http://acme.com&quot;</span>)
         , (<span class="st">&quot;new_site.start_date.year&quot;</span>, <span class="st">&quot;2014&quot;</span>)
         , (<span class="st">&quot;new_site.start_date.month&quot;</span>, <span class="st">&quot;1&quot;</span>)
         , (<span class="st">&quot;new_site.start_date.day&quot;</span>, <span class="st">&quot;3&quot;</span>)
         , (<span class="st">&quot;new_site.user_link_pattern&quot;</span>, <span class="st">&quot;http://acme.com/user/*&quot;</span>)
         , (<span class="st">&quot;new_site.issue_link_pattern&quot;</span>, <span class="st">&quot;http://acme.com/issue/*&quot;</span>)
         ])

  site_id <span class="ot">&lt;-</span> fmap fromJust <span class="fu">$</span> eval (newSite (<span class="dt">Site</span> (<span class="fu">-</span><span class="dv">1</span>) <span class="st">&quot;Some Site&quot;</span> <span class="st">&quot;http://acme.com&quot;</span>
                                            (<span class="dt">UTCTime</span> (fromGregorian <span class="dv">2014</span> <span class="dv">1</span> <span class="dv">1</span>) <span class="dv">0</span>)
                                            <span class="st">&quot;http://acme.com/user/*&quot;</span>
                                            <span class="st">&quot;http://acme.com/issue/*&quot;</span>))
  <span class="co">-- for use in forms</span>
  <span class="kw">let</span> site_params <span class="fu">=</span> params [ (<span class="st">&quot;edit_site.name&quot;</span>, <span class="st">&quot;Some Site&quot;</span>)
                           , (<span class="st">&quot;edit_site.url&quot;</span>, <span class="st">&quot;http://acme.com&quot;</span>)
                           , (<span class="st">&quot;edit_site.start_date.year&quot;</span>, <span class="st">&quot;2014&quot;</span>)
                           , (<span class="st">&quot;edit_site.start_date.month&quot;</span>, <span class="st">&quot;1&quot;</span>)
                           , (<span class="st">&quot;edit_site.start_date.day&quot;</span>, <span class="st">&quot;1&quot;</span>)
                           , (<span class="st">&quot;edit_site.user_link_pattern&quot;</span>, <span class="st">&quot;http://acme.com/user/*&quot;</span>)
                           , (<span class="st">&quot;edit_site.issue_link_pattern&quot;</span>, <span class="st">&quot;http://acme.com/issue/*&quot;</span>)
                           ]
  <span class="kw">let</span> site_url <span class="fu">=</span> B.append <span class="st">&quot;/site/&quot;</span> (T.encodeUtf8 <span class="fu">$</span> tshow site_id)
  name <span class="st">&quot;/site/:id redirect without login&quot;</span> <span class="fu">$</span>
    redirects (get site_url)
  cleanup clearAccounts <span class="fu">$</span> cleanup clearSites <span class="fu">$</span> withUser <span class="fu">$</span> <span class="kw">do</span>
    name <span class="st">&quot;/site/:id success with login&quot;</span> <span class="fu">$</span>
      succeeds (get site_url)
    name <span class="st">&quot;/site/:id has site name in response&quot;</span> <span class="fu">$</span>
      responds (get site_url) <span class="st">&quot;Some Site&quot;</span>
    name <span class="st">&quot;/site/:id/edit displays a page with a form on it&quot;</span> <span class="fu">$</span>
      responds (get <span class="fu">$</span> B.append site_url <span class="st">&quot;/edit&quot;</span>) <span class="st">&quot;&lt;form&quot;</span>
    name <span class="st">&quot;/site/:id/edit post changes url&quot;</span> <span class="fu">$</span>
      changes (const <span class="st">&quot;http://newacme.com&quot;</span>)
        (fmap (siteUrl<span class="fu">.</span>fromJust) <span class="fu">$</span> getSite site_id)
        (post (B.append site_url <span class="st">&quot;/edit&quot;</span>) <span class="fu">$</span> M.union (params [(<span class="st">&quot;edit_site.url&quot;</span>, <span class="st">&quot;http://newacme.com&quot;</span>)])
                                                    site_params)
    name <span class="st">&quot;/site/:id/edit redirects&quot;</span> <span class="fu">$</span>
      redirects (post (B.append site_url <span class="st">&quot;/edit&quot;</span>) site_params)</code></pre>
<p>There are two parts to make this work. The first is a small library that is providing most of the helpers here. The library is the following:</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">Snap.Testing</span>
       ( <span class="dt">SnapTesting</span>
       , <span class="dt">TestRequest</span>
       , runSnapTests
       , name
       , get
       , post
       , params
       , succeeds
       , notfound
       , redirects
       , changes
       , responds
       , cleanup
       , eval
       , modifySite
       ) <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Data.Map</span> (<span class="dt">Map</span>, fromList)
<span class="kw">import </span><span class="dt">Data.ByteString</span> (<span class="dt">ByteString</span>)
<span class="kw">import </span><span class="dt">Data.Text</span> (<span class="dt">Text</span>, unpack)
<span class="kw">import </span><span class="dt">Data.Text.Encoding</span> (encodeUtf8)
<span class="kw">import </span><span class="dt">Data.Monoid</span> (mempty)
<span class="kw">import </span><span class="dt">Control.Monad.Trans</span>
<span class="kw">import </span><span class="dt">Control.Monad.Trans.State</span> (<span class="dt">StateT</span>, evalStateT)
<span class="kw">import qualified</span> <span class="dt">Control.Monad.Trans.State</span> <span class="kw">as</span> <span class="dt">S</span> (get, put)
<span class="kw">import </span><span class="dt">Snap.Core</span> (<span class="dt">Response</span>)
<span class="kw">import </span><span class="dt">Snap.Snaplet</span> (<span class="dt">Handler</span>, <span class="dt">SnapletInit</span>)
<span class="kw">import </span><span class="dt">Snap.Test</span> (<span class="dt">RequestBuilder</span>,
                  assertSuccess, assert404, assertRedirect, assertBodyContains)
<span class="kw">import qualified</span> <span class="dt">Snap.Test</span> <span class="kw">as</span> <span class="dt">Test</span>
<span class="kw">import </span><span class="dt">Snap.Snaplet.Test</span> (runHandler, evalHandler)
<span class="kw">import </span><span class="dt">Test.HUnit</span> (<span class="dt">Assertion</span>, assertEqual, assertFailure)

<span class="co">-- Basic Types</span>
<span class="kw">type</span> <span class="dt">SnapTesting</span> b a <span class="fu">=</span> <span class="dt">StateT</span> (<span class="dt">Handler</span> b b (), <span class="dt">SnapletInit</span> b b) <span class="dt">IO</span> a
<span class="kw">type</span> <span class="dt">TestRequest</span> <span class="fu">=</span> <span class="dt">RequestBuilder</span> <span class="dt">IO</span> ()

<span class="ot">runSnapTests ::</span> <span class="dt">Handler</span> b b () <span class="ot">-&gt;</span> <span class="dt">SnapletInit</span> b b <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b () <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
runSnapTests site app <span class="fu">=</span> flip evalStateT (site, app)

<span class="co">-- Logging</span>
<span class="ot">name ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b () <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b ()
name s a <span class="fu">=</span> <span class="kw">do</span>
  lift <span class="fu">$</span> putStrLn s
  a

<span class="co">-- Requests</span>
<span class="ot">get ::</span> <span class="dt">ByteString</span> <span class="ot">-&gt;</span> <span class="dt">TestRequest</span>
get <span class="fu">=</span> flip Test.get mempty

<span class="ot">post ::</span> <span class="dt">ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Map</span> <span class="dt">ByteString</span> [<span class="dt">ByteString</span>] <span class="ot">-&gt;</span> <span class="dt">TestRequest</span>
post <span class="fu">=</span> Test.postUrlEncoded

<span class="ot">params ::</span> [(<span class="dt">ByteString</span>, <span class="dt">ByteString</span>)] <span class="ot">-&gt;</span> <span class="dt">Map</span> <span class="dt">ByteString</span> [<span class="dt">ByteString</span>]
params <span class="fu">=</span> fromList <span class="fu">.</span> map (\x <span class="ot">-&gt;</span> (fst x, [snd x]))

<span class="co">-- Assertions</span>
<span class="ot">succeeds ::</span> <span class="dt">TestRequest</span> <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b ()
succeeds req <span class="fu">=</span> run req assertSuccess

<span class="ot">notfound ::</span> <span class="dt">TestRequest</span> <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b ()
notfound req <span class="fu">=</span> run req assert404

<span class="ot">redirects ::</span> <span class="dt">TestRequest</span> <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b ()
redirects req <span class="fu">=</span> run req assertRedirect

<span class="ot">changes ::</span> (<span class="dt">Show</span> a, <span class="dt">Eq</span> a) <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">Handler</span> b b a <span class="ot">-&gt;</span> <span class="dt">TestRequest</span> <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b ()
changes delta measure req <span class="fu">=</span> <span class="kw">do</span>
  (site, app) <span class="ot">&lt;-</span> S.get
  before <span class="ot">&lt;-</span> eval measure
  _ <span class="ot">&lt;-</span> lift <span class="fu">$</span> runHandler (<span class="dt">Just</span> <span class="st">&quot;test&quot;</span>) req site app
  after <span class="ot">&lt;-</span> eval measure
  lift <span class="fu">$</span> assertEqual <span class="st">&quot;Expected value to change&quot;</span> (delta before) after

<span class="ot">responds ::</span> <span class="dt">TestRequest</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b ()
responds req mtch <span class="fu">=</span> run req (assertBodyContains (encodeUtf8 mtch))

<span class="co">-- Clean up</span>
<span class="ot">cleanup ::</span> <span class="dt">Handler</span> b b () <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b () <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b ()
cleanup cu act <span class="fu">=</span> <span class="kw">do</span>
  act
  (_, app) <span class="ot">&lt;-</span> S.get
  _ <span class="ot">&lt;-</span> lift <span class="fu">$</span> runHandler (<span class="dt">Just</span> <span class="st">&quot;test&quot;</span>) (get <span class="st">&quot;&quot;</span>) cu app
  return ()

<span class="co">-- Arbitrary code</span>
<span class="ot">eval ::</span> <span class="dt">Handler</span> b b a <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b a
eval act <span class="fu">=</span> <span class="kw">do</span>
  (_, app) <span class="ot">&lt;-</span> S.get
  lift <span class="fu">$</span> fmap (either (error<span class="fu">.</span> unpack) id) <span class="fu">$</span> evalHandler (<span class="dt">Just</span> <span class="st">&quot;test&quot;</span>) (get <span class="st">&quot;&quot;</span>) act app


<span class="co">-- Helpers to build app specific functionality</span>
<span class="ot">modifySite ::</span> (<span class="dt">Handler</span> b b () <span class="ot">-&gt;</span> <span class="dt">Handler</span> b b ()) <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b a <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b a
modifySite f act <span class="fu">=</span> <span class="kw">do</span>
  (site, app) <span class="ot">&lt;-</span> S.get
  S.put (f site, app)
  res <span class="ot">&lt;-</span> act
  S.put (site, app)
  return res

<span class="co">-- Private helpers</span>
<span class="ot">run ::</span> <span class="dt">TestRequest</span> <span class="ot">-&gt;</span>  (<span class="dt">Response</span> <span class="ot">-&gt;</span> <span class="dt">Assertion</span>) <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> b ()
run req asrt <span class="fu">=</span> <span class="kw">do</span>
  (site, app) <span class="ot">&lt;-</span> S.get
  res <span class="ot">&lt;-</span> lift <span class="fu">$</span> runHandler (<span class="dt">Just</span> <span class="st">&quot;test&quot;</span>) req site app
  <span class="kw">case</span> res <span class="kw">of</span>
    <span class="dt">Left</span> err <span class="ot">-&gt;</span> lift <span class="fu">$</span> assertFailure (show err)
    <span class="dt">Right</span> response <span class="ot">-&gt;</span> lift <span class="fu">$</span> asrt response</code></pre>
<p>And finally, there are a couple of helpers written in the first file, to make the <code>withUser</code> helper. It should be possible to make a general one on top of the auth snaplet, but my accounts are a little different anyway, so it’s not part of the generat library.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- Authentication</span>
<span class="ot">withUser ::</span> <span class="dt">SnapTesting</span> <span class="dt">App</span> a <span class="ot">-&gt;</span> <span class="dt">SnapTesting</span> <span class="dt">App</span> a
withUser <span class="fu">=</span> modifySite addRandomUser

<span class="co">-- reasonably likely to be unique</span>
<span class="ot">generateEmail ::</span> <span class="dt">IO</span> <span class="dt">Text</span>
generateEmail <span class="fu">=</span> <span class="kw">do</span>
  int <span class="ot">&lt;- randomIO ::</span> <span class="dt">IO</span> <span class="dt">Int</span>
  return <span class="fu">$</span> T.pack <span class="fu">$</span> (show <span class="fu">$</span> abs int) <span class="fu">++</span> <span class="st">&quot;@test.com&quot;</span>

<span class="ot">generateName ::</span> <span class="dt">IO</span> <span class="dt">Text</span>
generateName <span class="fu">=</span> <span class="kw">do</span>
  int <span class="ot">&lt;- randomIO ::</span> <span class="dt">IO</span> <span class="dt">Int</span>
  return <span class="fu">$</span> T.pack <span class="fu">$</span> <span class="st">&quot;Person #&quot;</span> <span class="fu">++</span> (show <span class="fu">$</span> abs int)

<span class="ot">addRandomUser ::</span> <span class="dt">AppHandler</span> a <span class="ot">-&gt;</span> <span class="dt">AppHandler</span> a
addRandomUser hndlr <span class="fu">=</span> <span class="kw">do</span>
  em <span class="ot">&lt;-</span> liftIO generateEmail
  name <span class="ot">&lt;-</span> liftIO generateName
  res <span class="ot">&lt;-</span> with auth <span class="fu">$</span> createUser em <span class="st">&quot;password&quot;</span>
  <span class="kw">case</span> res <span class="kw">of</span>
    <span class="co">-- NOTE(dbp 2014-01-03): These are bad errors, but I'm not sure how the types let us do better.</span>
    <span class="dt">Left</span> failure <span class="ot">-&gt;</span> <span class="kw">do</span>
      liftIO <span class="fu">$</span> putStrLn <span class="st">&quot;Could not create user&quot;</span>
      hndlr
    <span class="dt">Right</span> au <span class="ot">-&gt;</span> <span class="kw">do</span>
      newAccount (<span class="dt">Account</span> (fromJust <span class="fu">$</span> userId au) name <span class="dt">False</span>)
      with auth <span class="fu">$</span> forceLogin au
      hndlr</code></pre>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Extreme programming was published in 199, giving a lower bound on the age.<a href="#fnref1">↩</a></p></li>
</ol>
</div>

        <div id="footer">
            last modified: <a href="http://hub.darcs.net/dbp/dbpmail/changes">January  6, 2014</a> | <a href="../rss.xml">rss feed</a>
        </div>
    </body>
</html>
