<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>dbpmail.net :: A Hacker's Replacement for GMail</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="navigation">
            <a href="http://dbpmail.net">dbpmail.net</a>
            <a href="#" title="site created with hakyll, http://jaspervdj.be/hakyll/">::</a>
            <a href="../index.html">About</a>
            <a href="../essays.html">Essays</a>
            <a href="../projects.html">Projects</a>
            <a href="http://photo.dbpmail.net">Photos</a>
        </div>
        <h2>A Hacker's Replacement for GMail</h2>

<p>by <em>Daniel Patterson</em> on <strong>June 17, 2013</strong></p>

<h2 id="motivation">Motivation</h2>
<p>I reluctantly switched to GMail about six months ago, after using many so-called “replacements for GMail” (the last of which was Fastmail). All of them were missing one or more features that I require of email:</p>
<ol style="list-style-type: decimal">
<li>Access to the same email on multiple machines (but, these can all be machines I control).</li>
<li>Access to important email on my phone (Android).</li>
<li>Ability to organize messages by threads.</li>
<li>Ability to categorize messages by tags.</li>
<li>Good search functionality.</li>
</ol>
<p>But, while GMail has all of these things, there were nagging reasons why I still wanted an alternative: handing an advertising company most of my personal and professional correspondance seems like a bad idea, having no (meaningful) way to either sign or encrypt email is unfortunate, and while it isn’t a true deal-breaker, having lightweight programmatic access to my email is a really nice thing (you can get a really rough approximation of this with the RSS feeds GMail provides). Furthermore, I’d be happy if I only get important email on my phone (ie, I want a whitelist on the phone - unexpected email is not something that I need to respond to all the time, and this allows me to elevate the notification for these messages, as they truly are important).</p>
<p>Over the past several months, I gradually put together a mail system that provides all the required features, as well as the three bonuses (encryption, easy programmatic access, and phone whitelisting). I’m describing it as a “Hacker’s Replacement for GMail” as opposed to just a “Replacement for GMail” because it involves a good deal of familiarity with Unix (or at least, to set up and debug the whole system it did. Perhaps following along is easier). But, the end result is powerful enough that for me, it is worth it.</p>
<p>This is somewhere between an outline and a HOWTO. I’ve organized it roughly in order of how I set things up, but some of the parts are more sketches than detailed instructions - supplement it with normal documentation for all the parts. Without further ado:</p>
<h2 id="overall-design">Overall Design</h2>
<p>Exim4 as the mail server, Courier-IMAP for mobile usage, <a href="http://notmuchmail.org/">notmuch</a> to manage the email database+tags+search, <a href="https://github.com/teythoon/afew">afew</a> for managing notmuch tagging/email moving, the emacs client for notmuch on all computers, <a href="https://play.google.com/store/apps/details?id=com.fsck.k9">K9-Mail</a> on android. Mail is recieved by the mail server and put in a Archive subdirectory which is <em>not</em> configured for push in K9-Mail. The mail is processed and tagged by afew, and any messages with the tag “important” are moved into the Important subdirectory. This directory is set up for push in K9-Mail, so email is pushed out to it. No further tagging can be done through the mobile device, but that wasn’t a requirement. read/unread status will be synced back to notmuch, which <em>is</em> important.</p>
<h2 id="step-by-step-instructions">Step By Step Instructions</h2>
<ol style="list-style-type: decimal">
<li><p>The first and most important part is having a server. I’ve been really happy with VPSes I have from <a href="https://www.digitalocean.com/?refcode=93aab578a407">Digital Ocean</a> (warning: that’s a referral link. <a href="https://www.digitalocean.com">Here’s one without.</a>) - they provide big-enough VPSes for email and a simple website for $5/month. There are also many other providers. The important thing is to get a server, if you don’t already have one.</p></li>
<li><p>The next thing you’ll need is a domain name. You can use a subdomain of one you already have, but the simplest thing is to just get a new one. This is $10-15/year. Once you have it, you want to set a few records (these are set in the “Zone File”, and should be easy to set up through the online control panel of whatever registrar you used):</p></li>
</ol>
<pre><code>A mydomain.com IP.ADDR.OF.SERVER (mydomain.com might be written @)
MX 10 mydomain.com.</code></pre>
<p>This sets the domain to point to your server, and sets the mail record to point to that domain name. You will also need to set up a PTR record, or reverse DNS. If you got the server through Digital Ocean, you can set up the DNS records through them, and they allow you to set the PTR record for each server easily. Whereever you set it up, it should point at mydomain.com. (Note trailing period. Otherwise it will resolve to mydomain.com.mydomain.com - not what you want!).</p>
<ol start="3" style="list-style-type: decimal">
<li>Now set up the mail server itself. I use Debian, but it shouldn’t be terribly different with other distributions. Since Debian uses Exim4 by default, I used that, and set up Courier as an IMAP server. I followed these instructions: <a href="http://blog.edseek.com/~jasonb/articles/exim4_courier/">blog.edseek.com/~jasonb/articles/exim4_courier/</a>. The only important thing I had to change was to force the hostname, by finding the line it <code>/etc/exim4/exim4.conf.template</code> that looks like:</li>
</ol>
<pre><code>.ifdef MAIN_HARDCODE_PRIMARY_HOSTNAME</code></pre>
<p>And adding above it, <code>MAIN_HARDCODE_PRIMARY_HOSTNAME = mydomain.com</code>. This is so that the header that the mail server displays matches the domain. If this isn’t the case, some mail servers won’t deliver messages.</p>
<ol start="4" style="list-style-type: decimal">
<li>Now we want to set up our delivery. Create a <code>.forward</code> file in the home directory of the account on the server that is going to recieve mail. It should contain</li>
</ol>
<pre><code># Exim filter

save Maildir/.Archive</code></pre>
<p>What this does is put all mail that is recieved into the Archive subdirectory (the dots are convention of the version of the Maildir format that Courier-IMAP uses).</p>
<ol start="5" style="list-style-type: decimal">
<li>Next, we want to set up notmuch. You can install it and the python bindings (needed by afew) with:</li>
</ol>
<pre><code>aptitude install notmuch python-notmuch</code></pre>
<ol start="6" style="list-style-type: decimal">
<li><p>Run <code>notmuch setup</code> and put in your name, email, and make sure that the directory to your email archive is “/home/YOURUSER/Maildir”. Run <code>notmuch new</code> to have it create the directories and, if you tested the mail server by sending yourself messages, import those initial messages.</p></li>
<li><p>Install afew from <a href="https://github.com/teythoon/afew">github.com/teythoon/afew</a>. You can start with the default configuration, and then add filters that will add the tag ‘important’, as well as any other automatic tagging you want to have.</p></li>
</ol>
<p>Some simple filters look like:</p>
<pre><code>[Filter.0]
message = messages from someone
query = from:someone.important@email.com
tags = +important
[Filter.1]
message = messages I don't care about
query = subject:Deal
tags = -unread</code></pre>
<p>For the <code>[MailMover]</code> section, you want the configuration to look something like:</p>
<pre><code>[MailMover]
folders = Archive Important
max_age = 15

# rules
Archive = 'tag:important':.Important
Important = 'NOT tag:important':.Archive</code></pre>
<p>This says to take anything in Archive with the important tag and put it in important. Note that the folders we are moving to are prefixed with a dot, but the names of the folders aren’t. Now we need to set everything up to run automatically.</p>
<ol start="8" style="list-style-type: decimal">
<li>We are going to use inotify, and specifically the tool <code>incron</code>, to watch for changes in our .Archive inbox and add files to the database, tag them, and move those that should be moved to .Important. On Debian, you can obtain <code>incron</code> with:</li>
</ol>
<pre><code>aptitude install incron</code></pre>
<p>Now edit your incrontab (similar to crontab) with <code>incrontab -e</code> and put an entry like:</p>
<pre><code>/home/MYUSER/Maildir/.Archive/new IN_MOVED_TO,IN_NO_LOOP /home/MYUSER/bin/my-notmuch-new.sh</code></pre>
<p>This says that we want to watch for IN_MOVED_TO events, we don’t want to listen while the script is running (if something goes wrong with your importing script, you could cause an infinite spawning of processes, which will take down the server). When these occur, we call a script we’ve written. You can obviously put this anywhere, just make it executable:</p>
<pre><code>#!/bin/bash
/usr/local/bin/notmuch new &gt;&gt; /dev/null 2&gt;&amp;1
/usr/local/bin/afew -nt &gt;&gt; /dev/null 2&gt;&amp;1
/usr/local/bin/afew -m &gt;&gt; /dev/null 2&gt;&amp;1</code></pre>
<p>It is intentionally being very quiet because output from cron jobs will trigger emails… and thus if there were a mistake, we could be in infinite loop land again.</p>
<ol start="8" style="list-style-type: decimal">
<li><p>Now let’s set up the mobile client. Install K9-Mail, and set up your account with the incoming / outgoing mail server to be just ‘mydomain.com’. Click on the account, and it will show just Inbox (not helpful). Hit the menu button, then click folders, and check “display all folders”. Now hit the menu again and click folders and hit “refresh folders”. Provided at least one message has been put into Important and Archive, those should both show up now. Open the folder ‘Important’ and use the settings to enable push for it. Also add it to the Unified Inbox. Similarly, disable push on the Inbox (this latter doesn’t really matter, because we never deliver messages to the inbox). If you have trouble finding these settings (which I did for a while), note that the settings that are available are contingent upon the screen you are on. The folders settings only exist when you are looking at the list of folders (not the unified inbox / list of accounts, and not the contents of a folder).</p></li>
<li><p>Finally, the desktop client. I’m using the emacs client, because I spend most of my time inside emacs, but there are several other clients - one inside vim, one called ‘bower’ that is curses based, and a few others. <code>alot</code>, a python client, won’t work, because it assumes that the notmuch database is local (which is a really stupid assumption). The rest just assume that <code>notmuch</code> is in the path. This means that you can follow the instructions here: <a href="http://notmuchmail.org/remoteusage/">notmuchmail.org/remoteusage/</a>. To test, run <code>notmuch count</code> on your local machine, and it should return the same thing (the total number of messages) as it does on the mail server.</p></li>
</ol>
<p>Once this is working, install notmuch locally, so that you get the emacs bindings. You should now be able to run <code>M-x notmuch</code> in emacs and get to your inbox. Setting up mail sending is a little trickier - most of the documentation I found didn’t work!</p>
<p>The first thing to do, in case your ISP is like mine and blocks port 25, is to change the default listening port for the server. Open up <code>/etc/default/exim4</code> and set <code>SMTPLISTENEROPTIONS</code> equal to <code>-oX 25:587 -oP /var/run/exim4/exim.pid</code>. This will have it listen on both 25 and 587.</p>
<p>Next, set up emacs to use your mail server to send mail, and to load notmuch. This incantation in my <code>.emacs</code> did the trick:</p>
<pre><code>(require 'notmuch)
(setq smtpmail-starttls-credentials '((&quot;mydomain.com&quot; 587 nil nil))
      smtpmail-auth-credentials (expand-file-name &quot;~/.authinfo&quot;)
      smtpmail-default-smtp-server &quot;mydomain.com&quot;
      smtpmail-smtp-server &quot;mydomain.com&quot;
      smtpmail-smtp-service 587)
(require 'smtpmail)
(setq message-send-mail-function 'smtpmail-send-it)
(require 'starttls)</code></pre>
<p>Now eval your .emacs (or restart emacs), and you are almost ready to send mail.</p>
<p>You just need to put a line like this into <code>~/.authinfo</code>:</p>
<pre><code>machine mydomain.com login MYUSERNAME password MYPASSWORD port 587</code></pre>
<p>With appropriate permissions (<code>chmod 600 ~/.authinfo</code>).</p>
<p>Now you can test this by typing <code>C-x m</code> or <code>M-x notmuch</code> and then from there, hit the ‘m’ key - both of these open the composition window. Type a message and who it is to, and then type <code>C-c C-c</code> to send it. It should take a second and then say it was sent at the bottom of the window.</p>
<p>At this point, you should be pretty much set up. Pat yourself on the back - it was a bit of setup, but you now have a mail system that is more powerful than what GMail gives you, and is extensible and completely controlled by you!</p>

        <div id="footer">
            last modified: <a href="http://hub.darcs.net/dbp/dbpmail/changes">June 21, 2013</a>
        </div>
    </body>
</html>
